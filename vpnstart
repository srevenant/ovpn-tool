#!/bin/bash

sbase=$(dirname $0)
sbase=$(cd $sbase; pwd)

key=$1
base=$2

if [ ! $base ]; then
    base=~/.ovpn
fi

cd $base
keys=$(ls -1 *.ovpn|sed -e 's/\.ovpn$//')
count=$(echo "$keys" | wc -l)

if [ ! -f $key.ovpn ]; then
    if [ $count = 1 ]; then
        key=$keys
        echo "No key specified, defaulting to $keys"
    else
        printf "Specify a key to use: "
        echo $keys
        exit 1
    fi
fi

terminal_title() {
    printf "\033]0;$@\007"
}

terminal_title "vpn.$key"

if [ `id -u` != 0 ]; then
    sname=$(basename $0)
    script=$sbase/$sname
    echo "==> Switching to root with sudo..."
    exec sudo $script $key $base
else
    umask 077
    export PATH=/usr/local/sbin:/usr/local/bin:$PATH
    echo -n "==> Auth Key credentials in "
    secretfile=$(grep auth-user-pass $key.ovpn | awk '{print $2}')
    if ! gpg -d $secretfile.gpg > $secretfile; then
         exit 1
    fi
    printf "==> MFA Authentication at $(date)\nEnter Security Code: "
    read -s otp_pass
    printf "\r                    \r\n"
    sed -i -e "s/%{OTP}$/$otp_pass/g" $secretfile

    cleanup() {
        sleep 10
		if [ $(ps -eaf|grep vpnstart|grep -v grep|wc -l) -gt 1 ]; then
            exit
		fi
     	rm -f $secretfile
    }
    cleanup &

    exec openvpn --config $key.ovpn
fi

